<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BFV • Pixel + CAPI Dedupe</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:#0b0b0d;color:#f5f5f7;margin:0;padding:24px}
  .card{background:#111;border:1px solid #222;border-radius:14px;padding:18px;margin:0 auto 16px;max-width:900px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #333;background:#1b1b1f;color:#fff;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  pre{background:#0d0d0f;border:1px solid #222;border-radius:8px;padding:10px;overflow:auto}
  .muted{color:#aaa}.ok{color:#79ffa1}.bad{color:#ff6b6b}
</style>

<!-- Meta Pixel (auto features OFF) -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');

window.BFV = { PIXEL_ID: '1064489478594024' };   /* <-- SET THIS */
try { fbq('init', BFV.PIXEL_ID, {}, { autoConfig:false, autoLogAppEvents:false }); } catch(e){}
</script>
</head>
<body>
  <div class="card"><h1>BFV — Pixel + CAPI Dedupe</h1></div>

  <div class="card">
    <div class="row">
      <button id="btn-pv-browser">PageView (Browser)</button>
      <button id="btn-pv-server">PageView (Server)</button>
      <button id="btn-pv-both">PageView (Both, dedupe)</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn-lead-both">Lead (Both, dedupe)</button>
    </div>
  </div>

  <div class="card">
    <div class="muted">Current Event ID:</div>
    <div id="eid" class="muted">none</div>
  </div>

  <div class="card">
    <div class="muted">Server API Response:</div>
    <pre id="api" class="muted">no call yet…</pre>
  </div>

<script>
const eidEl = document.getElementById('eid');
const apiEl = document.getElementById('api');
let busy = false;

function newId(){ return (crypto?.randomUUID?.() || ('evt_' + Math.random().toString(36).slice(2) + Date.now())); }
function set(id){ eidEl.textContent = id; }
function showApi(obj, ok){ apiEl.textContent = JSON.stringify(obj,null,2); apiEl.className = ok ? 'ok' : 'bad'; }

async function sendServer(event_name, event_id, custom_data){
  const body = {
    event_name,
    event_id,
    event_source_url: window.location.href,   // EXACT match with browser
    custom_data: custom_data || undefined
  };
  const res = await fetch('/api/hook', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const json = await res.json().catch(()=>({}));
  showApi(json, res.ok);
  return res.ok;
}

// Browser send — keeps payload symmetrical with server
function sendBrowser(event_name, event_id, custom_data){
  try { fbq('track', event_name, custom_data || {}, { eventID: event_id }); } catch(e){}
}

async function sendBoth(event_name, custom_data){
  if (busy) return; busy = true;
  const id = newId(); set(id);

  // IMPORTANT: send same custom_data on both sides
  sendBrowser(event_name, id, custom_data);
  await sendServer(event_name, id, custom_data);

  setTimeout(()=>busy=false, 1200);
}

// Buttons
document.getElementById('btn-pv-browser').onclick = () => {
  const id = newId(); set(id);
  sendBrowser('PageView', id, undefined);        // no custom_data for PV
};

document.getElementById('btn-pv-server').onclick = async () => {
  const id = newId(); set(id);
  await sendServer('PageView', id, undefined);   // no custom_data for PV
};

document.getElementById('btn-pv-both').onclick = () => sendBoth('PageView', undefined);

document.getElementById('btn-lead-both').onclick = () => {
  // identical custom_data both sides
  const custom = { value: 1, currency: 'USD' };
  sendBoth('Lead', custom);
};
</script>
</body>
</html>
